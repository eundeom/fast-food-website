<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    
    <link
      rel="stylesheet"
      href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.0/css/bootstrap.min.css"
    />
    <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.9.3/dist/umd/popper.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.0/js/bootstrap.min.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <link rel="stylesheet" href="admin.css" />
</head>
<style>
    tr input{
        width: 40px;
    }
</style>
<body>
    <header>
        <nav>
          <form class="navbar">
            <div>
              <a href="adminstrator.html">Home</a>
              <a href="menuPage.html">Menu</a>
              <a href="userReport.html">Users Report</a>
              <a href="orderSales.html">Order & Sales</a>
              <a href="orderhistory.html">Order History</a>
            </div>
          </form>
        </nav>
    </header>
    <h1>Order History</h1>
    <table border="1">
        <thead>
            <tr>
                <th>Order ID</th>
                <th>Product</th>
                <th>User ID</th>
                <th>Date</th>
                <th>Rating</th>
            </tr>
        </thead>
        <tbody>

        </tbody>
    </table>
</body>
<script type="module">
    const postLoad = (data)=>{
        console.log(data)
    }
    const ratingUpdate = (obj)=>{
        let loadPromise = new Promise((load,error)=>{
            const xhr = new XMLHttpRequest();
            xhr.onload = ()=>{
                if(xhr.status == 200){
                    load(xhr.response);
                }else{
                    error(xhr.statusText);
                }
            }
            xhr.open("POST","http://localhost/php/fast-food-website/BackEnd/orderhistory.php");
            xhr.send(JSON.stringify(obj));
        }).then(postLoad,error)
        //console.log(obj);
    }
    const ratingBtn = (e,obj)=>{
        switch(e.target.innerText){
            case "Add rating":
                let tr = e.target.parentElement;
                let input = document.createElement("input");
                input.type = "number";
                tr.children[4].append(input);
                tr.children[5].innerText="Submit";
                break;
            case "Submit":
                let row = e.target.parentElement;
                let rating = Number(row.children[4].children[0].value);
                if(rating >= 0 && rating < 6 && rating != ''){
                    obj.rating = rating;
                    ratingUpdate(obj);
                    row.children[4].children[0].remove();
                    row.children[4].innerText = rating;
                    row.children[5].innerText="Delete rating";
                }else{
                    alert("please input a rating from 0 to 5");
                }
                break;
            case "Delete rating":
                let trow = e.target.parentElement;
                obj.rating = null;
                ratingUpdate(obj);
                trow.children[4].innerText = null;
                trow.children[5].innerText="Add rating";
                break;
        }
    }
    const load = (data)=>{
        //console.log(data);
        for(let obj of data){
            let tr = document.createElement("tr");
            for(let i in obj){
                let td = document.createElement("td");
                td.innerText = obj[i];
                tr.append(td);
            }
            //debugger;
            let btn = document.createElement("button");
            if(obj.rating != null){
                btn.innerText = "Delete rating";  
            }else{
                btn.innerText = "Add rating";
            }
            btn.addEventListener("click",(e)=>ratingBtn(e,obj));
            tr.append(btn);
            document.querySelector("tbody").append(tr);
        }
    }
    const error = (msg)=>{
        alert(msg);
    }
    let loadPromise = new Promise((load,error)=>{
        const xhr = new XMLHttpRequest();
        xhr.onload = ()=>{
            if(xhr.status == 200){
                load(JSON.parse(xhr.response));
            }else{
                error(xhr.statusText);
            }
        }
        xhr.open("GET","http://localhost/php/fast-food-website/BackEnd/orderhistory.php");
        xhr.send();
    }).then(load,error)
</script>
</html>